<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sessions - Music Recommendation</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="/styles.css" rel="stylesheet">
    
    <style>
        .sessions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .session-tile {
            aspect-ratio: 1;
            background: var(--color-paper);
            border: 2px solid var(--color-200);
            border-radius: 16px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .session-tile:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            border-color: var(--color-orange);
        }
        
        .session-tile.new-session {
            border: 2px dashed var(--color-300);
            background: var(--color-50);
        }
        
        .session-tile.new-session:hover {
            border-color: var(--color-orange);
            background: var(--color-100);
        }
        
        .session-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-900);
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }
        
        .session-genre {
            font-size: 0.85rem;
            color: var(--color-orange);
            background: rgba(188, 82, 21, 0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 8px;
            display: inline-block;
            margin-bottom: 0.5rem;
        }
        
        .session-stats {
            font-size: 0.75rem;
            color: var(--color-600);
            margin-top: auto;
        }
        
        .session-updated {
            font-size: 0.7rem;
            color: var(--color-500);
            margin-top: 0.25rem;
        }
        
        .new-session-icon {
            font-size: 2rem;
            color: var(--color-400);
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .new-session-text {
            text-align: center;
            color: var(--color-600);
            font-weight: 500;
        }
        
        .session-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .session-tile:hover .session-actions {
            opacity: 1;
        }
        
        .session-delete-btn {
            background: rgba(220, 53, 69, 0.1);
            border: none;
            color: var(--bs-danger);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }
        
        .session-delete-btn:hover {
            background: rgba(220, 53, 69, 0.2);
        }

        /* Modal styling to match paper background */
        .modal-content {
            background-color: var(--color-paper);
            border: 1px solid var(--color-200);
        }

        .modal-header {
            border-bottom-color: var(--color-200);
        }

        .modal-footer {
            border-top-color: var(--color-200);
        }

        /* Form fields styling to match paper theme */
        .modal .form-control,
        .modal .form-select {
            background-color: var(--color-50);
            border-color: var(--color-200);
            color: var(--color-900);
        }

        .modal .form-control:focus,
        .modal .form-select:focus {
            background-color: var(--color-paper);
            border-color: var(--color-orange);
            box-shadow: 0 0 0 0.25rem rgba(188, 82, 21, 0.15);
        }

        .modal .form-label {
            color: var(--color-900);
            font-weight: 600;
        }

        .modal .form-text {
            color: var(--color-600);
        }
    </style>
</head>
<body>
    <!-- User Header -->
    <nav class="user-header">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h5 mb-0 text-music">ðŸŽµ MusicRec</h1>
                <div id="userHeader">
                    <!-- User info will be added here by JavaScript -->
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
                <!-- Welcome Section -->
                <div class="text-center mb-5">
                    <h1 class="display-4 fw-bold text-music mb-3" id="welcomeMessage">
                        Welcome!
                    </h1>
                    <p class="lead text-muted">What shall we explore today?</p>
                </div>
                
                <!-- Sessions Grid -->
                <div class="sessions-grid" id="sessionsGrid">
                    <!-- Sessions will be loaded here -->
                    <div class="session-tile new-session" onclick="createNewSession()">
                        <div class="new-session-icon">+</div>
                        <div class="new-session-text">Create New Session</div>
                    </div>
                </div>
                
                <!-- Loading State -->
                <div class="text-center mt-5 d-none" id="loadingState">
                    <div class="spinner-border text-music" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading your sessions...</p>
                </div>
                
                <!-- Empty State -->
                <div class="text-center mt-5 d-none" id="emptyState">
                    <div class="mb-4">
                        <span style="font-size: 3rem; opacity: 0.5;">ðŸŽµ</span>
                    </div>
                    <h3 class="h5 text-muted">No sessions yet</h3>
                    <p class="text-muted">Create your first session to start exploring music!</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create Session Modal -->
    <div class="modal fade" id="createSessionModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Session</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createSessionForm">
                        <div class="mb-3">
                            <label for="sessionName" class="form-label">Session Name</label>
                            <input type="text" class="form-control" id="sessionName"
                                   placeholder="My Music Exploration" required maxlength="50">
                            <div class="form-text">Give your session a memorable name</div>
                        </div>
                        <div class="mb-3">
                            <label for="sessionGenre" class="form-label">Music Genre</label>
                            <select class="form-select" id="sessionGenre" required>
                                <option value="">Choose a genre to explore...</option>
                                <!-- Genre options will be loaded here -->
                            </select>
                            <div class="form-text">Select the music genre you want to explore in this session</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-music" onclick="submitCreateSession()">Create Session</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentUser = null;
        let sessions = [];
        
        // Authentication functions
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/user');
                const data = await response.json();
                
                const userHeader = document.getElementById('userHeader');
                const welcomeMessage = document.getElementById('welcomeMessage');
                
                if (data.authenticated) {
                    currentUser = data.user;
                    // User is logged in
                    userHeader.innerHTML = `
                        <div class="user-info">
                            Welcome, <span class="user-name">${data.user.username}</span>
                        </div>
                        <button class="logout-btn" onclick="handleLogout()">Logout</button>
                    `;
                    welcomeMessage.textContent = `Welcome ${data.user.username}!`;
                    
                    // Load user sessions
                    loadUserSessions(data.user.id);
                } else {
                    // User is not logged in, redirect to auth
                    window.location.href = '/auth';
                }
            } catch (error) {
                console.error('Error checking auth status:', error);
                // Redirect to auth on error
                window.location.href = '/auth';
            }
        }
        
        async function handleLogout() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    // Redirect to home page after logout
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Error logging out:', error);
            }
        }
        
        async function loadUserSessions(userId) {
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            const sessionsGrid = document.getElementById('sessionsGrid');
            
            // Show loading state
            loadingState.classList.remove('d-none');
            
            try {
                const response = await fetch(`/api/user/${userId}/sessions`);
                const data = await response.json();
                
                if (response.ok) {
                    sessions = data.sessions || [];
                    renderSessions();
                } else {
                    console.error('Error loading sessions:', data.error);
                    // Show empty state on error
                    showEmptyState();
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
                showEmptyState();
            } finally {
                loadingState.classList.add('d-none');
            }
        }
        
        function renderSessions() {
            const sessionsGrid = document.getElementById('sessionsGrid');
            const emptyState = document.getElementById('emptyState');
            
            // Clear existing sessions (keep the "new session" tile)
            const newSessionTile = sessionsGrid.querySelector('.new-session');
            sessionsGrid.innerHTML = '';
            sessionsGrid.appendChild(newSessionTile);
            
            if (sessions.length === 0) {
                showEmptyState();
                return;
            }
            
            // Hide empty state
            emptyState.classList.add('d-none');
            
            // Render session tiles
            sessions.forEach(session => {
                const tile = createSessionTile(session);
                sessionsGrid.appendChild(tile);
            });
        }
        
        function createSessionTile(session) {
            const tile = document.createElement('div');
            tile.className = 'session-tile';
            tile.onclick = () => selectSession(session.id);
            
            const updatedDate = session.updated_at ? 
                new Date(session.updated_at).toLocaleDateString() : 
                'Never';
            
            tile.innerHTML = `
                <div class="session-actions">
                    <button class="session-delete-btn" onclick="event.stopPropagation(); deleteSession(${session.id})" title="Delete session">
                        Ã—
                    </button>
                </div>
                <div>
                    <div class="session-name">${session.name}</div>
                    ${session.genre_group ? `<div class="session-genre">${session.genre_group}</div>` : ''}
                </div>
                <div>
                    <div class="session-stats">
                        ${session.pool_size || 0} tracks
                        ${session.adjustment_count ? ` â€¢ ${session.adjustment_count} filters` : ''}
                    </div>
                    <div class="session-updated">Updated ${updatedDate}</div>
                </div>
            `;
            
            return tile;
        }
        
        function showEmptyState() {
            const emptyState = document.getElementById('emptyState');
            emptyState.classList.remove('d-none');
        }
        
        function createNewSession() {
            const modal = new bootstrap.Modal(document.getElementById('createSessionModal'));

            // Load genres when modal opens
            loadGenresForModal();

            modal.show();

            // Focus on input when modal is shown
            document.getElementById('createSessionModal').addEventListener('shown.bs.modal', function () {
                document.getElementById('sessionName').focus();
            });
        }

        async function loadGenresForModal() {
            try {
                const response = await fetch('/api/genres');
                const genres = await response.json();

                const genreSelect = document.getElementById('sessionGenre');
                // Clear existing options (keep the first placeholder)
                genreSelect.innerHTML = '<option value="">Choose a genre to explore...</option>';

                // Add genre options
                genres.forEach(genre => {
                    const option = document.createElement('option');
                    option.value = genre;
                    option.textContent = genre;
                    genreSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading genres:', error);
                alert('Error loading genres. Please try again.');
            }
        }
        
        async function submitCreateSession() {
            const sessionName = document.getElementById('sessionName').value.trim();
            const sessionGenre = document.getElementById('sessionGenre').value;

            if (!sessionName) {
                alert('Please enter a session name');
                return;
            }

            if (!sessionGenre) {
                alert('Please select a music genre');
                return;
            }

            if (!currentUser) {
                alert('You must be logged in to create sessions');
                return;
            }

            try {
                const response = await fetch(`/api/user/${currentUser.id}/sessions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: sessionName,
                        genre: sessionGenre
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createSessionModal'));
                    modal.hide();

                    // Clear form
                    document.getElementById('sessionName').value = '';
                    document.getElementById('sessionGenre').value = '';

                    // Reload sessions
                    loadUserSessions(currentUser.id);
                } else {
                    alert(data.error || 'Failed to create session');
                }
            } catch (error) {
                console.error('Error creating session:', error);
                alert('Network error. Please try again.');
            }
        }
        
        async function selectSession(sessionId) {
            try {
                // Set the active session
                const response = await fetch(`/api/user/${currentUser.id}/sessions/current`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ session_id: sessionId })
                });
                
                if (response.ok) {
                    // All sessions now have genres set at creation, go directly to music player
                    window.location.href = '/embed.html';
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to select session');
                }
            } catch (error) {
                console.error('Error selecting session:', error);
                alert('Network error. Please try again.');
            }
        }
        
        async function deleteSession(sessionId) {
            if (!confirm('Are you sure you want to delete this session? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Reload sessions
                    loadUserSessions(currentUser.id);
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to delete session');
                }
            } catch (error) {
                console.error('Error deleting session:', error);
                alert('Network error. Please try again.');
            }
        }
        
        // Handle form submission with Enter key
        document.getElementById('sessionName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                submitCreateSession();
            }
        });
        
        // Check auth status and load sessions on page load
        checkAuthStatus();
    </script>
</body>
</html>