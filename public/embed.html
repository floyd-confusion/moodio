<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Embed</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 2rem;
            background-color: #f5f5f5;
        }
        .layout-container {
            max-width: 1600px;
            margin: 0 auto;
        }
        .main-container {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .adjustment-container {
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        .adjustment-content {
            display: flex;
            gap: 2rem;
            align-items: flex-start;
        }
        .adjustment-left {
            flex: 2;
        }
        .adjustment-right {
            flex: 1;
            min-width: 300px;
        }
        .pool-stats-container {
            background-color: #f8f9fa;
            border: 2px solid #6c757d;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        .reset-button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
        }
        .reset-button:hover {
            background-color: #c82333;
        }
        .control-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }
        .control-row {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .control-label {
            font-weight: 600;
            color: #333;
            min-width: 100px;
        }
        .player-container {
            flex: 3;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        .liked-container {
            flex: 2;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            min-width: 300px;
        }
        .adjustment-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0 0 0;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .adjustment-table th {
            background-color: #1DB954;
            color: white;
            padding: 0.75rem 0.5rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .adjustment-table td {
            padding: 0.75rem 0.5rem;
            text-align: center;
            border-bottom: 1px solid #eee;
            font-size: 0.85rem;
        }
        .adjustment-table tr:last-child td {
            border-bottom: none;
        }
        .metric-name {
            font-weight: 600;
            color: #333;
        }
        .adjustment-btn {
            background-color: #f8f8f8;
            border: 2px solid;
            padding: 0.5rem 1rem;
            margin: 0 0.25rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
            min-width: 40px;
        }
        .adjustment-btn.decrease {
            border-color: #e74c3c;
            color: #e74c3c;
        }
        .adjustment-btn.decrease:hover {
            background-color: #e74c3c;
            color: white;
        }
        .adjustment-btn.increase {
            border-color: #1DB954;
            color: #1DB954;
        }
        .adjustment-btn.increase:hover {
            background-color: #1DB954;
            color: white;
        }
        .adjustment-btn.progressive {
            font-weight: bold;
            border-width: 3px;
        }
        .adjustment-btn.progressive.increase {
            border-color: #ff6b35;
            color: #ff6b35;
            background: linear-gradient(45deg, rgba(255, 107, 53, 0.1), rgba(29, 185, 84, 0.1));
        }
        .adjustment-btn.progressive.increase:hover {
            background-color: #ff6b35;
            color: white;
        }
        .adjustment-btn.progressive.decrease {
            border-color: #9b59b6;
            color: #9b59b6;
            background: linear-gradient(45deg, rgba(155, 89, 182, 0.1), rgba(231, 76, 60, 0.1));
        }
        .adjustment-btn.progressive.decrease:hover {
            background-color: #9b59b6;
            color: white;
        }
        h1 {
            color: #333;
            margin-bottom: 2rem;
            text-align: center;
            font-size: 2.5rem;
        }
        .liked-title {
            color: #333;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            border-bottom: 2px solid #1DB954;
            padding-bottom: 0.5rem;
        }
        .content-wrapper {
            display: flex;
            gap: 4rem;
            align-items: flex-start;
        }
        .player-section {
            flex: 2;
        }
        .info-section {
            flex: 1;
            min-width: 400px;
        }
        .spotify-embed {
            margin: 4rem 0;
            border-radius: 16px;
            overflow: hidden;
        }
        .back-button {
            background-color: #1DB954;
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 2rem;
        }
        .back-button:hover {
            background-color: #1ed760;
        }
        .adjustment-buttons {
            display: flex;
            gap: 2rem;
            margin: 4rem 0;
            justify-content: center;
        }
        .adjust-button {
            background-color: #f8f8f8;
            border: 4px solid;
            padding: 1.5rem 3rem;
            font-size: 2.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 150px;
            justify-content: center;
        }
        .adjust-button.more {
            border-color: #1DB954;
            color: #1DB954;
        }
        .adjust-button.more:hover {
            background-color: #1DB954;
            color: white;
        }
        .adjust-button.less {
            border-color: #e74c3c;
            color: #e74c3c;
        }
        .adjust-button.less:hover {
            background-color: #e74c3c;
            color: white;
        }
        .like-button {
            background-color: #f8f8f8;
            border: 2px solid #1DB954;
            color: #1DB954;
            padding: 0.5rem 1rem;
            font-size: 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 1rem;
            flex: 1;
        }
        .like-button:hover {
            background-color: #1DB954;
            color: white;
        }
        .like-button.liked {
            background-color: #1DB954;
            color: white;
        }
        .liked-tracks-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .liked-track-item {
            padding: 0.75rem;
            border-bottom: 1px solid #ddd;
            font-size: 0.9rem;
            color: #666;
            transition: background-color 0.2s;
        }
        .liked-track-item:hover {
            background-color: #f8f8f8;
        }
        .liked-track-item:last-child {
            border-bottom: none;
        }
        .info-card {
            background-color: #f8f8f8;
            border-radius: 16px;
            padding: 2rem;
            margin-top: 4rem;
        }
        .info-title {
            font-size: 2rem;
            color: #333;
            margin-bottom: 2rem;
            border-bottom: 4px solid #1DB954;
            padding-bottom: 1rem;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .info-label {
            font-size: 1.2rem;
            color: #666;
        }
        .info-value {
            font-size: 1.4rem;
            color: #333;
            font-weight: 500;
        }
        .button-container {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .user-header {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .user-info {
            color: #666;
            font-size: 0.9rem;
        }
        
        .user-name {
            font-weight: 600;
            color: #1DB954;
        }
        
        .auth-link, .logout-btn {
            color: #1DB954;
            text-decoration: none;
            font-size: 0.9rem;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
        }
        
        .auth-link:hover, .logout-btn:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="user-header" id="userHeader">
        <!-- User info will be added here by JavaScript -->
    </div>
    
    <div class="layout-container">
        <!-- Main Controls and Liked Tracks Frame -->
        <div class="main-container">
            <div class="player-container">
                <button class="back-button" onclick="window.location.href='/genres'">‚Üê Back to Genre Selection</button>
                <h1>Spotify Preview</h1>
                <div class="content-wrapper">
                    <div class="player-section">
                        <div class="spotify-embed">
                            <iframe id="spotifyEmbed"
                                    width="100%" 
                                    height="456" 
                                    frameborder="0" 
                                    allowfullscreen="" 
                                    allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                                    loading="lazy">
                            </iframe>
                        </div>
                    </div>
                    <div class="info-section">
                        <div class="info-card">
                            <h2 class="info-title">Track Information</h2>
                            <div class="info-grid" id="trackInfo">
                                <!-- Track info will be populated here -->
                            </div>
                        </div>
                        <div class="button-container">
                            <button class="like-button" id="likeButton" onclick="toggleLike()">üëç</button>
                            <button class="like-button" id="nextButton" onclick="loadInitialTrack()">Next</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="liked-container">
                <h2 class="liked-title">Liked Tracks</h2>
                <ul class="liked-tracks-list" id="likedTracksList">
                    <!-- Liked tracks will be populated here -->
                </ul>
            </div>
        </div>
        
        <!-- Adjustment Controls Frame -->
        <div class="adjustment-container">
            <h2 style="margin-top: 0; color: #333; text-align: center;">üéõÔ∏è Adjustment Controls</h2>
            <div class="adjustment-content">
                <div class="adjustment-left">
                    <!-- Simple Control Buttons -->
                    <div class="control-buttons">
                        <div class="control-row">
                            <span class="control-label">Danceability:</span>
                            <button class="adjustment-btn decrease" onclick="adjustPool(0)">-</button>
                            <button class="adjustment-btn increase" onclick="adjustPool(1)">+</button>
                        </div>
                        <div class="control-row">
                            <span class="control-label">Energy:</span>
                            <button class="adjustment-btn decrease" onclick="adjustPool(2)">-</button>
                            <button class="adjustment-btn increase" onclick="adjustPool(3)">+</button>
                        </div>
                        <div class="control-row">
                            <span class="control-label">Speechiness:</span>
                            <button class="adjustment-btn decrease" onclick="adjustPool(4)">-</button>
                            <button class="adjustment-btn increase" onclick="adjustPool(5)">+</button>
                        </div>
                        <div class="control-row">
                            <span class="control-label">Valence:</span>
                            <button class="adjustment-btn decrease" onclick="adjustPool(6)">-</button>
                            <button class="adjustment-btn increase" onclick="adjustPool(7)">+</button>
                        </div>
                        <div class="control-row">
                            <span class="control-label">Tempo:</span>
                            <button class="adjustment-btn decrease" onclick="adjustPool(8)">-</button>
                            <button class="adjustment-btn increase" onclick="adjustPool(9)">+</button>
                        </div>
                        
                        <!-- Progressive Filters -->
                        <div class="control-row" style="margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem;">
                            <span class="control-label" style="font-weight: bold; color: #1DB954;">Progressive Acousticness:</span>
                            <button class="adjustment-btn increase progressive" onclick="adjustPool(10)" title="50% ‚Üí 75% ‚Üí 90%+">++</button>
                            <button class="adjustment-btn decrease progressive" onclick="adjustPool(11)" title="50% ‚Üí 25% ‚Üí 10%-">--</button>
                        </div>
                        <div class="control-row">
                            <span class="control-label" style="font-weight: bold; color: #1DB954;">Progressive Instrumentalness:</span>
                            <button class="adjustment-btn increase progressive" onclick="adjustPool(12)" title="50% ‚Üí 75% ‚Üí 90%+">++</button>
                            <button class="adjustment-btn decrease progressive" onclick="adjustPool(13)" title="50% ‚Üí 25% ‚Üí 10%-">--</button>
                        </div>
                        <div class="control-row">
                            <span class="control-label" style="font-weight: bold; color: #1DB954;">Progressive Liveness:</span>
                            <button class="adjustment-btn increase progressive" onclick="adjustPool(14)" title="50% ‚Üí 75% ‚Üí 90%+">++</button>
                            <button class="adjustment-btn decrease progressive" onclick="adjustPool(15)" title="50% ‚Üí 25% ‚Üí 10%-">--</button>
                        </div>
                    </div>
                    
                    <!-- Adjustment History Table -->
                    <h3 style="margin-top: 2rem; color: #333;">üìã Adjustment History</h3>
                    <table class="adjustment-table">
                        <thead>
                            <tr>
                                <th rowspan="2">#</th>
                                <th rowspan="2">Adjustment</th>
                                <th rowspan="2">Time</th>
                                <th colspan="2">Pool Size</th>
                                <th colspan="5">Average Features After</th>
                            </tr>
                            <tr>
                                <th>Before</th>
                                <th>After</th>
                                <th>Dance</th>
                                <th>Energy</th>
                                <th>Speech</th>
                                <th>Valence</th>
                                <th>Tempo</th>
                            </tr>
                        </thead>
                        <tbody id="adjustmentHistoryTable">
                            <tr>
                                <td colspan="10" style="text-align: center; color: #666; font-style: italic;">No adjustments made yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="adjustment-right">
                    <div class="pool-stats-container">
                        <h3 style="margin-top: 0; color: #333;">üìä Pool Stats</h3>
                        <div id="poolStats">
                            <!-- Pool statistics will be populated here -->
                        </div>
                    </div>
                    <button class="reset-button" onclick="resetPool()">üîÑ Reset Pool</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTrackId = null;
        let likedTracks = new Set();

        function updateLikeButton() {
            const likeButton = document.getElementById('likeButton');
            if (likedTracks.has(currentTrackId)) {
                likeButton.classList.add('liked');
            } else {
                likeButton.classList.remove('liked');
            }
        }

        function toggleLike() {
            if (!currentTrackId) return;

            fetch('/api/likes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ track_id: currentTrackId })
            })
            .then(response => response.json())
            .then(result => {
                if (!result.error) {
                    if (likedTracks.has(currentTrackId)) {
                        likedTracks.delete(currentTrackId);
                    } else {
                        likedTracks.add(currentTrackId);
                    }
                    updateLikeButton();
                    loadLikedTracks();
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function loadAdjustmentHistory() {
            fetch('/api/adjustment_history')
                .then(response => response.json())
                .then(data => {
                    const historyTable = document.getElementById('adjustmentHistoryTable');
                    const adjustments = data.adjustments || [];
                    
                    if (adjustments.length === 0) {
                        historyTable.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #666; font-style: italic;">No adjustments made yet</td></tr>';
                        return;
                    }
                    
                    // Map adjustment IDs to readable format
                    const paramMap = {
                        0: 'Danceability ‚Üì', 1: 'Danceability ‚Üë',
                        2: 'Energy ‚Üì', 3: 'Energy ‚Üë', 
                        4: 'Speechiness ‚Üì', 5: 'Speechiness ‚Üë',
                        6: 'Valence ‚Üì', 7: 'Valence ‚Üë',
                        8: 'Tempo ‚Üì', 9: 'Tempo ‚Üë',
                        10: 'Acousticness Progressive ‚Üë', 11: 'Acousticness Progressive ‚Üì',
                        12: 'Instrumentalness Progressive ‚Üë', 13: 'Instrumentalness Progressive ‚Üì',
                        14: 'Liveness Progressive ‚Üë', 15: 'Liveness Progressive ‚Üì'
                    };
                    
                    historyTable.innerHTML = adjustments.map((adj, index) => {
                        const time = new Date(adj.timestamp).toLocaleTimeString();
                        const adjustmentText = paramMap[adj.adjustment_id] || `${adj.parameter} ${adj.direction}`;
                        const poolBefore = adj.pool_size_before ? adj.pool_size_before.toLocaleString() : 'N/A';
                        const poolAfter = adj.pool_size_after ? adj.pool_size_after.toLocaleString() : 'N/A';
                        
                        // Get average stats after the adjustment
                        const stats = adj.avg_stats_after || {};
                        const dance = stats.danceability ? stats.danceability.toFixed(3) : 'N/A';
                        const energy = stats.energy ? stats.energy.toFixed(3) : 'N/A';
                        const speech = stats.speechiness ? stats.speechiness.toFixed(3) : 'N/A';
                        const valence = stats.valence ? stats.valence.toFixed(3) : 'N/A';
                        const tempo = stats.tempo ? Math.round(stats.tempo) : 'N/A';
                        
                        return `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${adjustmentText}</td>
                                <td>${time}</td>
                                <td>${poolBefore}</td>
                                <td>${poolAfter}</td>
                                <td>${dance}</td>
                                <td>${energy}</td>
                                <td>${speech}</td>
                                <td>${valence}</td>
                                <td>${tempo}</td>
                            </tr>
                        `;
                    }).join('');
                })
                .catch(error => {
                    console.error('Error loading adjustment history:', error);
                    document.getElementById('adjustmentHistoryTable').innerHTML = 
                        '<tr><td colspan="10" style="text-align: center; color: #e74c3c;">Error loading history</td></tr>';
                });
        }

        function loadPoolStats() {
            fetch('/api/pool_stats')
                .then(response => response.json())
                .then(stats => {
                    const poolStatsDiv = document.getElementById('poolStats');
                    poolStatsDiv.innerHTML = `
                        <div style="margin-bottom: 0.5rem;"><strong>Total DB:</strong> ${stats.total_tracks.toLocaleString()}</div>
                        <div style="margin-bottom: 0.5rem;"><strong>Genre Pool:</strong> ${stats.genre_pool_size.toLocaleString()}</div>
                        <div style="margin-bottom: 0.5rem;"><strong>Playback Pool:</strong> ${stats.playback_pool_size.toLocaleString()}</div>
                        <div style="margin-bottom: 0.5rem;"><strong>Filters Applied:</strong> ${stats.filters_applied}</div>
                        <div style="margin-bottom: 0.5rem;"><strong>Tracks Shown:</strong> ${stats.tracks_shown || 0}</div>
                        <div style="margin-bottom: 0.5rem;"><strong>Reduction:</strong> ${stats.pool_reduction_pct}%</div>
                        <hr style="margin: 0.5rem 0; border-color: #999;">
                        <div style="font-size: 0.8rem; color: #666;">
                            <div><strong>Avg Pool Features:</strong></div>
                            <div>Dance: ${stats.avg_stats.danceability || 'N/A'}</div>
                            <div>Energy: ${stats.avg_stats.energy || 'N/A'}</div>
                            <div>Speech: ${stats.avg_stats.speechiness || 'N/A'}</div>
                            <div>Valence: ${stats.avg_stats.valence || 'N/A'}</div>
                            <div>Tempo: ${stats.avg_stats.tempo || 'N/A'}</div>
                            <div>Acoustic: ${stats.avg_stats.acousticness || 'N/A'}</div>
                            <div>Instrumental: ${stats.avg_stats.instrumentalness || 'N/A'}</div>
                            <div>Liveness: ${stats.avg_stats.liveness || 'N/A'}</div>
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('Error loading pool stats:', error);
                    document.getElementById('poolStats').innerHTML = '<div style="color: #e74c3c;">Error loading stats</div>';
                });
        }

        function resetPool() {
            if (!confirm('Reset pool to original state? This will clear all adjustments.')) {
                return;
            }
            
            fetch('/api/clear_adjustments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(result => {
                if (!result.error) {
                    loadPoolStats();
                    loadAdjustmentHistory();
                    // Load a new track from the reset pool
                    loadInitialTrack();
                } else {
                    alert('Error resetting pool: ' + result.error);
                }
            })
            .catch(error => {
                console.error('Error resetting pool:', error);
                alert('Error resetting pool');
            });
        }

        function loadLikedTracks() {
            fetch('/api/likes')
                .then(response => response.json())
                .then(data => {
                    likedTracks = new Set(data.liked_tracks);
                    updateLikeButton();
                    
                    const likedTracksList = document.getElementById('likedTracksList');
                    likedTracksList.innerHTML = '';
                    
                    if (likedTracks.size === 0) {
                        likedTracksList.innerHTML = '<li class="liked-track-item">No liked tracks yet</li>';
                        return;
                    }

                    // Get track details for each liked track
                    Promise.all(Array.from(likedTracks).map(trackId => 
                        fetch(`/api/track/${trackId}`)
                            .then(response => response.json())
                            .catch(() => null)
                    ))
                    .then(tracks => {
                        tracks.filter(track => track).forEach(track => {
                            const li = document.createElement('li');
                            li.className = 'liked-track-item';
                            li.textContent = `${track.track_name} - ${track.artist_name}`;
                            likedTracksList.appendChild(li);
                        });
                    });
                })
                .catch(error => console.error('Error:', error));
        }

        function formatValue(value) {
            if (typeof value === 'number') {
                return value.toFixed(2);
            }
            return value;
        }

        function updateTrackInfo(track) {
            const infoGrid = document.getElementById('trackInfo');
            const infoItems = [
                { label: 'Track Name', value: track.track_name },
                { label: 'Artist', value: track.artist_name },
                { label: 'Genre', value: track.genre },
                { label: 'Danceability', value: track.danceability },
                { label: 'Energy', value: track.energy },
                { label: 'Speechiness', value: track.speechiness },
                { label: 'Valence', value: track.valence },
                { label: 'Tempo', value: `${track.tempo} BPM` },
                { label: 'Acousticness', value: track.acousticness },
                { label: 'Instrumentalness', value: track.instrumentalness },
                { label: 'Liveness', value: track.liveness }
            ];

            infoGrid.innerHTML = infoItems.map(item => `
                <div class="info-item">
                    <span class="info-label">${item.label}</span>
                    <span class="info-value">${formatValue(item.value)}</span>
                </div>
            `).join('');
        }

        function adjustPool(adjustment) {
            fetch('/api/adjust_pool', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ adjustment: parseInt(adjustment) })
            })
            .then(response => response.json())
            .then(result => {
                if (!result.error) {
                    return fetch('/api/track');
                }
                throw new Error(result.error);
            })
            .then(response => response.json())
            .then(track => {
                currentTrackId = track.track_id;
                document.getElementById('spotifyEmbed').src = `https://open.spotify.com/embed/track/${track.track_id}?autoplay=1`;
                updateTrackInfo(track);
                updateLikeButton();
                loadPoolStats(); // Refresh pool stats after adjustment
                loadAdjustmentHistory(); // Refresh adjustment history
            })
            .catch(error => console.error('Error:', error));
        }

        function loadInitialTrack() {
            fetch('/api/track')
                .then(response => response.json())
                .then(track => {
                    if (track.error) {
                        throw new Error(track.error);
                    }
                    currentTrackId = track.track_id;
                    document.getElementById('spotifyEmbed').src = `https://open.spotify.com/embed/track/${track.track_id}?autoplay=1`;
                    updateTrackInfo(track);
                    updateLikeButton();
                    loadPoolStats(); // Load pool stats with new track
                })
                .catch(error => {
                    console.error('Error:', error);
                    window.location.href = '/';
                });
        }

        // Authentication functions
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/user');
                const data = await response.json();
                
                const userHeader = document.getElementById('userHeader');
                
                if (data.authenticated) {
                    // User is logged in
                    userHeader.innerHTML = `
                        <div class="user-info">
                            Welcome, <span class="user-name">${data.user.username}</span>
                        </div>
                        <button class="logout-btn" onclick="handleLogout()">Logout</button>
                    `;
                } else {
                    // User is not logged in
                    userHeader.innerHTML = `
                        <a href="/auth" class="auth-link">Login / Register</a>
                    `;
                }
            } catch (error) {
                console.error('Error checking auth status:', error);
                // Show login link if there's an error
                const userHeader = document.getElementById('userHeader');
                userHeader.innerHTML = `
                    <a href="/auth" class="auth-link">Login / Register</a>
                `;
            }
        }
        
        async function handleLogout() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    // Redirect to home page after logout
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Error logging out:', error);
            }
        }

        // Load initial track, liked tracks, adjustment history, and check auth status
        loadInitialTrack();
        loadLikedTracks();
        loadAdjustmentHistory();
        checkAuthStatus();
    </script>
</body>
</html> 